<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>FTSO - Faceit Tournament Standoff Organisation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: #121212 url('your_firestrike_background.jpg') no-repeat center center fixed; /* Замените 'your_firestrike_background.jpg' на ваш путь к изображению */
            background-size: cover;
            color: #fff;
            margin: 0;
            padding: 0;
        }

        .overlay { /* Добавлен оверлей для лучшей читаемости текста на фоне */
            background: rgba(0, 0, 0, 0.7);
            min-height: 100vh;
            padding-bottom: 20px;
            box-sizing: border-box;
        }

        .navbar {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            display: flex;
            justify-content: flex-start; /* Изменено на flex-start */
            align-items: center;
            gap: 40px; /* Увеличиваем промежуток между FTSO и блоком кнопок */
        }

        .navbar h1 {
            color: #e53935; /* Красный логотип */
            margin: 0;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .navbar div {
            display: flex;
            flex-grow: 1;
            justify-content: space-around;
            gap: 20px;
        }

        .navbar div button {
            flex-grow: 1;
            padding: 8px 15px;
        }

        button {
            background: #e53935;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        #authPage,
        #mainPage > div {
            padding: 20px;
            max-width: 700px;
            margin: 30px auto;
            background: rgba(34, 34, 34, 0.9);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
        }

        input,
        textarea {
            background: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 12px;
            font-size: 16px;
            width: calc(100% - 24px);
            box-sizing: border-box;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        h2 {
            color: #e53935;
            margin-top: 0;
            margin-bottom: 25px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #e53935;
            padding-bottom: 10px;
        }

        #confirmationResult {
            margin-top: 20px;
            white-space: pre-wrap;
            background: #333;
            padding: 15px;
            border-radius: 6px;
            min-height: 80px;
            border: 1px solid #555;
        }

        /* Стили для чата */
        #chatPage #chatContainer {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            height: 350px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* ВАЖНО для правильного отображения новых сообщений */
            border: 1px solid #555;
        }

        #chatPage .message {
            background: #444;
            color: white;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            word-break: break-word;
            border: 1px solid #555;
        }

        #chatPage .message b {
            color: #ddd;
            font-weight: 700;
        }

        #chatPage #chatInputArea {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        #chatPage #chatInput {
            flex-grow: 1;
        }

        /* Новые стили для поиска матчей и драфта */
        #matchPage #matchFormatButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        #matchPage #matchFormatButtons button {
            width: auto;
            padding: 12px 30px;
            font-size: 18px;
        }

        #matchPage #waitingPlayers {
            margin-top: 20px;
            background: #333;
            padding: 20px;
            border-radius: 6px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            text-align: center;
            font-size: 1.1em;
            border: 1px solid #555;
        }

        #matchPage #waitingPlayers ul {
            list-style: none;
            padding: 0;
        }

        #matchPage #waitingPlayers li {
            padding: 5px 0;
            color: #ccc;
        }

        #matchPage #matchSetup {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #555;
        }

        #matchPage #draftArea {
            margin-top: 20px;
            background: #333;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 1px solid #555;
        }

        #matchPage #playerList {
            background: #444;
            border-radius: 6px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            border: 1px solid #555;
        }

        #matchPage .player-selectable {
            cursor: pointer;
            padding: 10px;
            border-radius: 4px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-align: center;
            background-color: #555;
        }

        #matchPage .player-selectable:hover {
            background-color: #666;
            transform: translateY(-2px);
        }

        #matchPage .player-selected {
            background: #4caf50 !important;
            color: white;
            font-weight: bold;
            transform: none !important;
        }

        #matchPage #teams {
            display: flex;
            gap: 30px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        #matchPage .team {
            flex: 1;
            min-width: 250px;
            background: #444;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #666;
        }

        #matchPage .team h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #e53935;
            text-align: center;
            font-size: 1.3em;
        }

        #matchPage .team ul {
            list-style: none;
            padding: 0;
        }

        #matchPage .team li {
            padding: 8px 0;
            border-bottom: 1px dashed #555;
            font-size: 1.1em;
        }

        #matchPage .team li:last-child {
            border-bottom: none;
        }


        #matchPage #cancelMatchSearchBtn {
            margin-top: 20px;
            background-color: #dc3545;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #matchPage #cancelMatchSearchBtn:hover {
            background-color: #c82333;
        }

        #matchPage #matchFoundNotification {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        #matchPage #endDraftBtn {
            margin-top: 20px;
            background-color: #007bff;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #matchPage #endDraftBtn:hover {
            background-color: #0056b3;
        }

        /* Стили для профиля */
        #profilePage h2, #otherPlayerProfilePage h2 {
            text-align: left; /* Выравниваем заголовок слева */
            padding-left: 20px; /* Отступ слева */
        }

        #profilePage .profile-container, #otherPlayerProfilePage .profile-container {
            background: rgba(34, 34, 34, 0.9);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
            padding: 20px;
            margin-bottom: 15px;
            position: relative; /* Для позиционирования ELO */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #profilePage .profile-header, #otherPlayerProfilePage .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        #profilePage .avatar-container, #otherPlayerProfilePage .avatar-container {
            position: relative; /* Для абсолютного позиционирования кнопки загрузки (если потребуется) */
        }

        #profilePage .avatar-container img, #otherPlayerProfilePage .avatar-container img {
            display: block;
            object-fit: cover; /* Чтобы изображение не искажалось */
        }

        #profilePage .avatar-container input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        #profilePage .profile-login, #otherPlayerProfilePage .profile-login {
            color: #e53935;
            font-size: 20px;
            font-weight: bold;
        }

        #profilePage .profile-info > div, #otherPlayerProfilePage .profile-info > div {
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        #profilePage .profile-info b, #otherPlayerProfilePage .profile-info b {
            color: #ddd;
        }

        #profilePage .profile-rating, #otherPlayerProfilePage .profile-rating {
            position: absolute;
            bottom: 15px;
            right: 20px;
            font-size: 1.2em;
            color: #64b5f6; /* Пример цвета для ELO */
        }

        #profilePage .profile-rating b, #otherPlayerProfilePage .profile-rating b {
            color: #bbdefb;
        }

        /* Стили для списка игроков */
        #playersPage #playersList {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }

        #playersPage #playersList li {
            background: #333;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid #555;
            font-size: 1.1em;
            display: flex; /* Для размещения кнопки рядом с текстом */
            justify-content: space-between; /* Распределение содержимого */
            align-items: center; /* Выравнивание по центру */
        }

        #playersPage #playersList li button {
            padding: 5px 10px;
            font-size: 0.9em;
            margin-left: 10px; /* Отступ от текста */
        }


        /* Стили для админ-панели */
        #adminPage > div {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 8px;
            background: #333;
            border: 1px solid #555;
        }

        #adminPage h3 {
            color: #f44336;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #f44336;
            padding-bottom: 8px;
            font-size: 1.2em;
        }

        #adminPage input,
        #adminPage button,
        #adminPage div {
            margin-bottom: 10px;
        }

        #adminPage button {
            background-color: #f44336;
        }
        #adminPage button:hover {
            background-color: #d32f2f;
        }

        /* НОВЫЕ СТИЛИ ДЛЯ СЕКЦИИ "ПРОВЕРКА" */
        #verificationPage > div {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
            background: rgba(34, 34, 34, 0.9);
            border: 1px solid #555;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #verificationPage .request-item {
            background: #2a2a2a;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            position: relative; /* Для кнопки закрытия */
        }

        #verificationPage .request-item h4 {
            color: #66bb6a; /* Зеленый для имени отправителя */
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #4caf50;
            padding-bottom: 5px;
        }

        #verificationPage .request-item pre {
            white-space: pre-wrap; /* Сохраняет форматирование и переносит строки */
            word-break: break-word;
            background: #333;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px; /* Ограничиваем высоту */
            overflow-y: auto; /* Добавляем прокрутку, если контент большой */
            border: 1px solid #555;
            margin-top: 5px;
        }

        #verificationPage .request-item img {
            max-width: 100%;
            height: auto;
            display: block;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #555;
        }

        #verificationPage .request-item .action-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        #verificationPage .request-item .action-buttons button {
            padding: 8px 15px;
            font-size: 0.9em;
        }
        #verificationPage .request-item .action-buttons .delete-button {
            background-color: #dc3545; /* Красная кнопка для удаления */
        }
        #verificationPage .request-item .action-buttons .delete-button:hover {
            background-color: #c82333;
        }

        #verificationPage .request-item .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            color: #aaa;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        #verificationPage .request-item .close-button:hover {
            color: #fff;
            transform: scale(1.1);
        }

        /* НОВЫЕ СТИЛИ ДЛЯ БЕЙДЖА УВЕДОМЛЕНИЙ В ЧАТЕ */
        .navbar-button-wrapper {
            position: relative;
            display: inline-block; /* Чтобы wrapper не занимал всю ширину */
        }

        .chat-notification-badge {
            position: absolute;
            top: -5px; /* Регулируйте для лучшего позиционирования */
            right: -5px; /* Регулируйте для лучшего позиционирования */
            background-color: #e53935; /* Красный цвет */
            color: white;
            border-radius: 50%; /* Делаем его круглым */
            padding: 2px 6px; /* Регулируйте для размера кружка */
            font-size: 0.8em;
            font-weight: bold;
            min-width: 18px; /* Минимальная ширина для одной цифры */
            text-align: center;
            line-height: 1.2;
            box-shadow: 0 0 5px rgba(0,0,0,0.5); /* Небольшая тень для объема */
            display: none; /* Скрыт по умолчанию */
        }

    </style>
</head>
<body>
    <div class="overlay">
        <div class="navbar">
            <h1>FTSO</h1>
            <div id="navbar">
                </div>
        </div>

        <div id="authPage">
            <h2>Вход / Регистрация</h2>
            <input type="text" id="loginInput" placeholder="Логин" />
            <input type="text" id="gameIdInput" placeholder="Game ID (числовой)" />
            <input type="password" id="passwordInput" placeholder="Пароль" />
            <input type="password" id="confirmPasswordInput" placeholder="Подтвердите пароль" />
            <button onclick="register()">Регистрация</button>
            <button onclick="login()">Войти</button>
            <div id="authMessage"></div>
        </div>

        <div id="mainPage" class="hidden">
            <div id="profilePage">
                <h2>Профиль пользователя</h2>
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="avatar-container">
                            <img id="profileAvatar" src="default_avatar.png" alt="Аватар" width="80" height="80" style="border-radius: 50%; cursor: pointer;">
                            <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                        </div>
                        <div id="profileLogin" class="profile-login"></div>
                    </div>
                    <div class="profile-info">
                        <div><b>Game ID:</b> <span id="profileGameId"></span></div>
                    </div>
                    <div id="profileRating" class="profile-rating"></div>
                </div>
            </div>

            <div id="otherPlayerProfilePage" class="hidden">
                <h2>Профиль игрока: <span id="otherProfileLogin"></span></h2>
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="avatar-container">
                            <img id="otherProfileAvatar" src="default_avatar.png" alt="Аватар" width="80" height="80" style="border-radius: 50%;">
                        </div>
                        <div id="otherProfileLoginDisplay" class="profile-login"></div>
                    </div>
                    <div class="profile-info">
                        <div><b>Game ID:</b> <span id="otherProfileGameId"></span></div>
                    </div>
                    <div id="otherProfileRating" class="profile-rating"></div>
                </div>
                <button onclick="showSection('playersPage')" style="margin-top: 20px;">Вернуться к поиску игроков</button>
            </div>
            <div id="matchPage" class="hidden">
                <h2>Поиск матчей</h2>
                <div id="matchFormatButtons">
                    <button onclick="startMatchSearch(1)">1х1</button>
                    <button onclick="startMatchSearch(2)">2х2</button>
                    <button onclick="startMatchSearch(3)">3х3</button>
                    <button onclick="startMatchSearch(4)">4х4</button>
                    <button onclick="startMatchSearch(5)">5х5</button>
                </div>
                <button id="cancelMatchSearchBtn" class="hidden" onclick="cancelMatchSearch()">Отменить поиск</button>

                <div id="waitingPlayers" class="hidden">
                    <b>Игроки в поиске матча:</b>
                    <ul id="waitingPlayersList"></ul>
                    <div id="matchFoundNotification" class="hidden">Матч найден!</div>
                </div>

                <div id="matchSetup" class="hidden">
                    <b>Выбранная карта:</b> <span id="selectedMap"></span>
                    <div id="captainDraftArea" class="hidden">
                        <h3>Капитанский драфт</h3>
                        <div id="draftArea">
                            <div id="captainsInfo"></div>
                            <div id="playerList"></div>
                        </div>
                        <div id="teams">
                            <div class="team" id="teamA">
                                <h3>Команда 1 (<span id="sideA"></span>)</h3>
                                <ul id="teamAPlayers"></ul>
                            </div>
                            <div class="team" id="teamB">
                                <h3>Команда 2 (<span id="sideB"></span>)</h3>
                                <ul id="teamBPlayers"></ul>
                            </div>
                        </div>
                        <button id="endDraftBtn" class="hidden" onclick="endDraftEarly()">Завершить драфт</button>
                    </div>
                </div>
            </div>

            <div id="playersPage" class="hidden">
                <h2>Поиск игроков</h2>
                <input type="text" id="playerSearchInput" placeholder="Поиск по логину или Game ID" oninput="filterPlayers()" />
                <ul id="playersList"></ul>
            </div>

            <div id="draftPage" class="hidden">
                <h2>Капитанский драфт</h2>
                <p>Здесь будет логика капитанского драфта (можно добавить позже)</p>
            </div>

            <div id="chatPage" class="hidden">
                <h2>Чат</h2>
                <div id="chatContainer">
                </div>
                <div id="chatInputArea">
                    <input type="text" id="chatInput" placeholder="Введите сообщение..." />
                    <button onclick="sendMessage()">Отправить</button>
                </div>
            </div>

            <div id="confirmationPage" class="hidden">
                <h2>Подтверждение результата матча</h2>
                <input type="file" id="matchImage" accept="image/*" />
                <textarea id="matchStats" placeholder="Вставьте сюда статистику матча..." style="width: 100%; height: 120px; margin-top: 15px; background: #333; color: white; border-radius: 8px; border: none; padding: 10px;"></textarea>
                <button onclick="submitConfirmation()">Отправить подтверждение</button>
                <div id="confirmationMessage" style="color: lightgreen; margin-top: 10px;"></div>
            </div>

            <div id="verificationPage" class="hidden">
                <h2>Проверка подтверждений матчей</h2>
                <div id="verificationRequestsContainer">
                    <p id="noRequestsMessage" class="hidden">Нет новых запросов на проверку.</p>
                </div>
            </div>
            <div id="adminPage" class="hidden">
                <h2>Админ Панель</h2>

                <div>
                    <h3>Забанить пользователя</h3>
                    <input type="text" id="banUserInput" placeholder="Логин пользователя">
                    <button onclick="banUser()">Забанить</button>
                    <div id="banUserResult"></div>
                </div>

                <div>
                    <h3>Разбанить пользователя</h3>
                    <input type="text" id="unbanUserInput" placeholder="Логин пользователя">
                    <button onclick="unbanUser()">Разбанить</button>
                    <div id="unbanUserResult"></div>
                </div>

                <div>
                    <h3>Удалить пользователя</h3>
                    <input type="text" id="deleteUserInput" placeholder="Логин пользователя">
                    <button onclick="deleteUser()">Удалить</button>
                    <div id="deleteUserResult"></div>
                </div>

                <div>
                    <h3>Сменить никнейм</h3>
                    <input type="text" id="changeNickUserInput" placeholder="Логин пользователя">
                    <input type="text" id="newNickInput" placeholder="Новый никнейм">
                    <button onclick="changeNickname()">Сменить</button>
                    <div id="changeNickResult"></div>
                </div>

                <div>
                    <h3>Сменить Game ID</h3>
                    <input type="text" id="changeGameIdUserInput" placeholder="Логин пользователя">
                    <input type="text" id="newGameIdInput" placeholder="Новый Game ID">
                    <button onclick="changeGameId()">Сменить</button>
                    <div id="changeGameIdResult"></div>
                </div>

                <div>
                    <h3>Изменить рейтинг</h3>
                    <input type="text" id="changeRatingUserInput" placeholder="Логин пользователя">
                    <input type="number" id="newRatingInput" placeholder="Новый рейтинг">
                    <button onclick="changeRating()">Изменить</button>
                    <div id="changeRatingResult"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('users') || '{}');
        let currentUser = null; // Будет инициализирован при загрузке или входе
        let chatMessages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
        let verificationRequests = JSON.parse(localStorage.getItem('verificationRequests') || '[]');

        // Новая переменная для счетчика непрочитанных сообщений
        let unreadMessagesCount = 0;

        const navbar = document.getElementById('navbar');
        const authPage = document.getElementById('authPage');
        const mainPage = document.getElementById('mainPage');
        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const matchFormatButtons = document.getElementById('matchFormatButtons');
        const waitingPlayersDiv = document.getElementById('waitingPlayers');
        const matchSetupDiv = document.getElementById('matchSetup');
        const waitingPlayersList = document.getElementById('waitingPlayersList');
        const cancelMatchSearchBtn = document.getElementById('cancelMatchSearchBtn');
        const matchFoundNotification = document.getElementById('matchFoundNotification');
        const endDraftBtn = document.getElementById('endDraftBtn');

        // Элементы для профиля текущего пользователя
        const profileAvatar = document.getElementById('profileAvatar');
        const avatarInput = document.getElementById('avatarInput');

        // Элементы для профиля другого игрока
        const otherProfileAvatar = document.getElementById('otherProfileAvatar');
        const otherProfileLoginDisplay = document.getElementById('otherProfileLoginDisplay');
        const otherProfileGameId = document.getElementById('otherProfileGameId');
        const otherProfileRating = document.getElementById('otherProfileRating');


        let searchIntervalId = null;
        let currentMatchFormat = 0;

        const maps = ['Sandstone', 'Sakura', 'Rust', 'Breeze', 'Province', 'Dune', 'Zone 7'];
        let neededPlayersCount = 0;
        let foundPlayers = [];
        let selectedMap = '';
        let captainLogins = [];
        let teams = { teamA: [], teamB: [] };
        let currentCaptainTurn = 0;
        let playersToPick = [];
        let playersInSearch = {};

        // --- Функции для сохранения/загрузки состояния матча ---
        function saveMatchState() {
            const matchState = {
                searchIntervalActive: searchIntervalId !== null,
                currentMatchFormat: currentMatchFormat,
                neededPlayersCount: neededPlayersCount,
                foundPlayers: foundPlayers,
                selectedMap: selectedMap,
                captainLogins: captainLogins,
                teams: teams,
                currentCaptainTurn: currentCaptainTurn,
                playersToPick: playersToPick,
                playersInSearch: playersInSearch
            };
            localStorage.setItem('matchState', JSON.stringify(matchState));
        }

        function loadMatchState() {
            const savedState = localStorage.getItem('matchState');
            if (savedState) {
                const matchState = JSON.parse(savedState);
                currentMatchFormat = matchState.currentMatchFormat;
                neededPlayersCount = matchState.neededPlayersCount;
                foundPlayers = matchState.foundPlayers;
                selectedMap = matchState.selectedMap;
                captainLogins = matchState.captainLogins;
                teams = matchState.teams;
                currentCaptainTurn = matchState.currentCaptainTurn;
                playersToPick = matchState.playersToPick;
                playersInSearch = matchState.playersInSearch || {};

                if (matchState.searchIntervalActive && foundPlayers.length < neededPlayersCount) {
                    if (!searchIntervalId) {
                        searchIntervalId = setInterval(simulatePlayerSearch, 1500);
                    }
                } else if (foundPlayers.length === neededPlayersCount && neededPlayersCount > 0) {
                     clearInterval(searchIntervalId);
                     searchIntervalId = null;
                }
            }
        }

        // --- Функция обновления ELO из поста на форуме (без изменений) ---
        function updateEloFromForumPost(forumPostText) {
            const lines = forumPostText.split('\n');
            const updates = [];
            const cooldown = 300000;
            const now = Date.now();

            lines.forEach(line => {
                const match = line.match(/(\d+) - (победа|поражение) = ([+-]\d+)/i);
                if (match) {
                    const gameId = match[1];
                    const result = match[2].toLowerCase();
                    const eloChange = parseInt(match[3]);
                    let userFound = false;

                    for (const userLogin in users) {
                        if (users[userLogin].gameId === gameId) {
                            const lastUpdate = users[userLogin].lastEloUpdateTime || 0;
                            if (now - lastUpdate < cooldown) {
                                const timeLeft = Math.ceil((cooldown - (now - lastUpdate)) / 1000);
                                updates.push(`ID: ${gameId}: подождите еще ${timeLeft} секунд перед повторным обновлением ELO.`);
                                userFound = true;
                                continue;
                            }

                            users[userLogin].rating += eloChange;
                            users[userLogin].lastEloUpdateTime = now;
                            users[userLogin].matchesPlayed = (users[userLogin].matchesPlayed || 0) + 1;
                            updates.push(`ID: ${gameId}: ${result} (${eloChange > 0 ? '+' : ''}${eloChange} ELO)`);
                            userFound = true;
                            break;
                        }
                    }

                    if (!userFound) {
                        updates.push(`Не найден пользователь с ID: ${gameId}`);
                    }
                } else {
                    if (line.trim() !== '') {
                        updates.push(`Не удалось распознать строку: "${line}"`);
                    }
                }
            });

            localStorage.setItem('users', JSON.stringify(users));

            if (updates.length > 0) {
                const chatMessage = { user: 'EloSystem', text: 'Обновление ELO:\n' + updates.join('\n') };
                chatMessages.push(chatMessage);
                localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
                loadChatMessages(); // Перезагружаем чат после системного сообщения
            }
            return updates.join('\n');
        }

        // --- Функции отображения разделов и навигации ---
        function showSection(id) {
            // Добавлена новая страница в список всех секций
            const allSectionIds = ['profilePage', 'otherPlayerProfilePage', 'matchPage', 'playersPage', 'draftPage', 'chatPage', 'confirmationPage', 'leaderboardPage', 'adminPage', 'verificationPage'];
            allSectionIds.forEach(sectionId => {
                const sectionElement = document.getElementById(sectionId);
                if (sectionElement) {
                    sectionElement.classList.add('hidden');
                }
            });
            const targetElement = document.getElementById(id);
            if (targetElement) {
                targetElement.classList.remove('hidden');
            }

            // Добавляем логику для чата
            if (id === 'chatPage') {
                loadChatMessages(); // Загружаем все сообщения при входе в чат
                unreadMessagesCount = 0; // Сбрасываем счетчик
                updateChatNotificationBadge(); // Скрываем значок
            } else if (id === 'verificationPage') {
                loadVerificationRequests();
            } else if (id === 'profilePage') {
                loadProfile(); // Убедимся, что профиль обновляется при каждом показе
            } else if (id === 'playersPage') { // При переходе на страницу поиска игроков, обновим список
                filterPlayers();
            }

            if (id === 'matchPage') {
                if (searchIntervalId !== null) {
                    matchFormatButtons.classList.add('hidden');
                    waitingPlayersDiv.classList.remove('hidden');
                    cancelMatchSearchBtn.classList.remove('hidden');
                    matchSetupDiv.classList.add('hidden');
                    matchFoundNotification.classList.add('hidden');
                    document.getElementById('captainDraftArea').classList.add('hidden');
                    endDraftBtn.classList.add('hidden');
                    updateWaitingPlayers();
                } else if (foundPlayers.length === neededPlayersCount && neededPlayersCount > 0 && (playersToPick.length > 0 || (teams.teamA.length > 0 && teams.teamB.length > 0 && playersToPick.length === 0))) {
                    matchFormatButtons.classList.add('hidden');
                    waitingPlayersDiv.classList.add('hidden');
                    cancelMatchSearchBtn.classList.add('hidden');
                    matchSetupDiv.classList.remove('hidden');
                    document.getElementById('selectedMap').textContent = selectedMap;
                    document.getElementById('captainDraftArea').classList.remove('hidden');
                    setupCaptainDraft(true);
                    updateTeamViews();
                    updateCaptainTurnDisplay();

                    if (currentUser && (captainLogins[0] === currentUser || captainLogins[1] === currentUser || currentUser === 'HAESHE4KA')) {
                        endDraftBtn.classList.remove('hidden');
                    } else {
                        endDraftBtn.classList.add('hidden');
                    }
                } else {
                    matchFormatButtons.classList.remove('hidden');
                    waitingPlayersDiv.classList.add('hidden');
                    cancelMatchSearchBtn.classList.add('hidden');
                    matchSetupDiv.classList.add('hidden');
                    matchFoundNotification.classList.add('hidden');
                    document.getElementById('captainDraftArea').classList.add('hidden');
                    endDraftBtn.classList.add('hidden');
                }
            }
        }

        // ОБНОВЛЕННАЯ ФУНКЦИЯ updateNavbar()
        function updateNavbar() {
            const existingNavbarDiv = document.querySelector('.navbar #navbar');
            if (existingNavbarDiv) {
                existingNavbarDiv.innerHTML = '';
            } else {
                console.error("Элемент с id 'navbar' не найден в .navbar");
                return;
            }

            if (!currentUser) {
                authPage.classList.remove('hidden');
                mainPage.classList.add('hidden');
            } else {
                authPage.classList.add('hidden');
                mainPage.classList.remove('hidden');

                const buttonsConfig = [
                    { text: 'Профиль', section: 'profilePage' },
                    {
                        text: 'Поиск матчей',
                        action: () => {
                            showSection('matchPage');
                        }
                    },
                    { text: 'Поиск игроков', section: 'playersPage' },
                    { text: 'Чат', section: 'chatPage', isChatButton: true }, // Сделаем эту кнопку специальной
                    { text: 'Подтверждение', section: 'confirmationPage' },
                    { text: 'Таблица лидеров', section: 'leaderboardPage' },
                    { text: 'Выйти', action: logout }
                ];

                if (currentUser === 'HAESHE4KA') {
                    buttonsConfig.push({ text: 'Админ Панель', section: 'adminPage' });
                    buttonsConfig.splice(buttonsConfig.length - 2, 0, { text: 'Проверка', section: 'verificationPage' });
                }

                buttonsConfig.forEach(config => {
                    const button = document.createElement('button');
                    button.textContent = config.text;

                    if (config.isChatButton) {
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('navbar-button-wrapper');

                        const badge = document.createElement('span');
                        badge.id = 'chatNotificationBadge';
                        badge.classList.add('chat-notification-badge');
                        // Не добавляем 'hidden' здесь, его состояние будет управляться updateChatNotificationBadge()
                        wrapper.appendChild(button);
                        wrapper.appendChild(badge); // Сначала кнопка, потом бейдж

                        button.onclick = () => showSection(config.section);
                        existingNavbarDiv.appendChild(wrapper);
                    } else if (config.action) {
                        button.onclick = config.action;
                        existingNavbarDiv.appendChild(button);
                    } else if (config.section) {
                        button.onclick = () => showSection(config.section);
                        existingNavbarDiv.appendChild(button);
                    }
                });

                loadProfile();
                showSection('profilePage');
                // Убедимся, что счетчик сбрасывается и значок обновляется при логине/обновлении навигации,
                // если мы не на странице чата
                const currentSectionElement = document.querySelector('#mainPage > div:not(.hidden)');
                const currentSectionId = currentSectionElement ? currentSectionElement.id : null;
                if (currentSectionId !== 'chatPage') {
                     // Можно загрузить unreadMessagesCount из localStorage, если хотите сохранять его между сессиями
                     // Для простоты пока оставим его сбрасываемым при логине, если не на странице чата
                     // unreadMessagesCount = parseInt(localStorage.getItem('unreadMessagesCount_' + currentUser) || '0');
                } else {
                     unreadMessagesCount = 0; // Если мы сразу на странице чата, сбросить
                }

                updateChatNotificationBadge(); // Обновляем значок после создания и установки счетчика
            }
        }

        // --- Функции регистрации/входа/выхода ---
        function register() {
            const login = document.getElementById('loginInput').value.trim();
            const gameId = document.getElementById('gameIdInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;
            const authMessage = document.getElementById('authMessage');

            if (!login || !gameId || !password || !confirmPassword) {
                authMessage.textContent = 'Пожалуйста, заполните все поля.';
                authMessage.style.color = 'red';
                return;
            }

            if (password !== confirmPassword) {
                authMessage.textContent = 'Пароли не совпадают.';
                authMessage.style.color = 'red';
                return;
            }

            if (users[login]) {
                authMessage.textContent = 'Пользователь с таким логином уже существует.';
                authMessage.style.color = 'red';
                return;
            }

            for (const u in users) {
                if (users[u].gameId === gameId) {
                    authMessage.textContent = 'Game ID уже используется другим игроком.';
                    authMessage.style.color = 'red';
                    return;
                }
            }

            users[login] = { gameId, rating: 1000, lastEloUpdateTime: 0, matchesPlayed: 0, password: password };
            localStorage.setItem('users', JSON.stringify(users));
            authMessage.textContent = 'Регистрация успешна! Теперь войдите.';
            authMessage.style.color = 'lightgreen';

            document.getElementById('loginInput').value = '';
            document.getElementById('gameIdInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('confirmPasswordInput').value = '';
        }

        function login() {
            const login = document.getElementById('loginInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const authMessage = document.getElementById('authMessage');

            if (users[login] && users[login].password === password) {
                currentUser = login;
                localStorage.setItem('loggedInUser', currentUser); // Сохраняем логин текущего пользователя
                updateNavbar();
                authMessage.textContent = '';
                loadMatchState();
            } else {
                authMessage.textContent = 'Неверный пароль или пользователь не найден.';
                authMessage.style.color = 'red';
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('loggedInUser'); // Удаляем сохраненный логин
            updateNavbar();
            cancelMatchSearch();
            profileAvatar.src = 'default_avatar.png'; // Сбрасываем аватарку при выходе
            unreadMessagesCount = 0; // Сбрасываем счетчик при выходе
            updateChatNotificationBadge();
        }

        // --- Новая функция для автоматического входа ---
        function autoLogin() {
            const savedUser = localStorage.getItem('loggedInUser');
            if (savedUser && users?.[savedUser]) { // Проверяем, существует ли такой пользователь
                currentUser = savedUser;
                console.log(`Автоматический вход для пользователя: ${currentUser}`);
                updateNavbar();
                loadMatchState();
            }
        }

        // Функция для загрузки аватарки
        function loadAvatar(userLogin, imgElement) {
            if (!userLogin || !imgElement) {
                console.error("loadAvatar called without userLogin or imgElement");
                return;
            }
            const savedAvatar = localStorage.getItem('userAvatar_' + userLogin);
            if (savedAvatar) {
                imgElement.src = savedAvatar;
            } else {
                imgElement.src = 'default_avatar.png'; // Путь к стандартной аватарке
            }
        }

        // Обработчик клика на аватарку текущего пользователя для открытия диалога выбора файла
        profileAvatar.addEventListener('click', () => {
            if (currentUser) { // Разрешить смену только авторизованным пользователям
                avatarInput.click();
            } else {
                alert('Пожалуйста, войдите в аккаунт, чтобы изменить аватар.');
            }
        });

        // Обработчик выбора нового файла аватарки для текущего пользователя
        avatarInput.addEventListener('change', (event) => {
            const file = event.target.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    profileAvatar.src = e.target.result;
                    localStorage.setItem('userAvatar_' + currentUser, e.target.result); // Сохраняем аватарку
                };
                reader.onerror = (e) => {
                    console.error("Error reading image file:", e);
                    alert('Ошибка при чтении файла изображения.');
                };
                reader.readAsDataURL(file);
            }
        });

        function loadProfile() {
            if (!currentUser) return;
            const user = users?.[currentUser]; // Используем опциональную цепочку для безопасности
            document.getElementById('profileLogin').textContent = currentUser;
            document.getElementById('profileGameId').textContent = user?.gameId || 'N/A'; // Выводим N/A если нет данных
            document.getElementById('profileRating').innerHTML = `<b>ELO:</b> ${user?.rating || 'N/A'}`; // innerHTML для bold тега
            loadAvatar(currentUser, profileAvatar); // Загружаем аватарку при загрузке профиля
        }

        // НОВАЯ ФУНКЦИЯ ДЛЯ ПРОСМОТРА ПРОФИЛЯ ДРУГОГО ИГРОКА
        function viewPlayerProfile(login) {
            const player = users[login];
            if (!player) {
                alert('Профиль игрока не найден.');
                return;
            }

            document.getElementById('otherProfileLogin').textContent = login;
            document.getElementById('otherProfileLoginDisplay').textContent = login;
            document.getElementById('otherProfileGameId').textContent = player.gameId || 'N/A';
            document.getElementById('otherProfileRating').innerHTML = `<b>ELO:</b> ${player.rating || 'N/A'}`;

            loadAvatar(login, otherProfileAvatar); // Загружаем аватарку для другого игрока

            showSection('otherPlayerProfilePage'); // Переключаемся на страницу профиля другого игрока
        }

        // ОБНОВЛЕННАЯ ФУНКЦИЯ filterPlayers()
        function filterPlayers() {
            const input = document.getElementById('playerSearchInput').value.toLowerCase();
            const list = document.getElementById('playersList');
            list.innerHTML = '';

            Object.entries(users).forEach(([login, data]) => {
                // Исключаем текущего пользователя из списка
                if (login === currentUser) {
                    return;
                }

                if (login.toLowerCase().includes(input) || data.gameId.includes(input)) {
                    const li = document.createElement('li');

                    const textSpan = document.createElement('span');
                    textSpan.textContent = `${login} (Game ID: ${data.gameId}) Рейтинг: ${data.rating}`;
                    li.appendChild(textSpan);

                    const profileButton = document.createElement('button');
                    profileButton.textContent = 'Профиль';
                    profileButton.onclick = () => viewPlayerProfile(login);
                    li.appendChild(profileButton);

                    list.appendChild(li);
                }
            });
        }

        // ОБНОВЛЕННАЯ ФУНКЦИЯ loadChatMessages()
        function loadChatMessages() {
            chatContainer.innerHTML = ''; // Очищаем контейнер перед загрузкой
            try {
                // Попытка получить сообщения из localStorage и распарсить их
                chatMessages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
            } catch (e) {
                console.error("Error parsing chatMessages from localStorage:", e);
                // Если произошла ошибка при парсинге, инициализируем как пустой массив
                chatMessages = [];
                // Опционально: можно уведомить пользователя или администратора о повреждении данных
                alert("Ошибка загрузки истории чата. Возможно, данные были повреждены. Чат очищен.");
                localStorage.removeItem('chatMessages'); // Удаляем поврежденные данные
            }

            // Переворачиваем массив, чтобы последние сообщения были внизу
            const reversedMessages = [...chatMessages].reverse(); // Создаем копию и переворачиваем ее

            reversedMessages.forEach(msg => {
                appendMessageToChat(msg, false); // false, чтобы не увеличивать счетчик при загрузке
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ОБНОВЛЕННАЯ ФУНКЦИЯ appendMessageToChat()
        function appendMessageToChat(msg, incrementUnread = true) {
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `<b>${msg.user}</b>: ${msg.text}`;
            // Добавляем сообщение в начало, чтобы они отображались в правильном порядке
            chatContainer.prepend(div); // <-- ИЗМЕНЕНИЕ ЗДЕСЬ: используем prepend вместо append
            chatContainer.scrollTop = chatContainer.scrollHeight; // Убедитесь, что прокрутка внизу

            // Увеличиваем счетчик, если сообщение не от текущего пользователя
            // И если страница чата не активна
            const currentSectionElement = document.querySelector('#mainPage > div:not(.hidden)');
            const currentSectionId = currentSectionElement ? currentSectionElement.id : null;

            if (incrementUnread && msg.user !== currentUser && currentSectionId !== 'chatPage') {
                unreadMessagesCount++;
                updateChatNotificationBadge();
            }
        }

        function sendMessage() {
            if (!currentUser) return alert('Войдите, чтобы писать в чат');
            const text = chatInput.value.trim();
            if (!text) return;

            const newMessage = { user: currentUser, text };
            chatMessages.push(newMessage);
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
            chatInput.value = '';

            // Вместо полной перезагрузки чата, просто добавляем новое сообщение
            appendMessageToChat(newMessage, false); // false, потому что это сообщение отправил текущий пользователь
        }

        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // Новая функция для обновления кружка уведомлений
        function updateChatNotificationBadge() {
            const badge = document.getElementById('chatNotificationBadge');
            if (badge) {
                if (unreadMessagesCount > 0) {
                    badge.classList.remove('hidden');
                    badge.textContent = unreadMessagesCount > 9 ? '9+' : unreadMessagesCount.toString();
                } else {
                    badge.classList.add('hidden');
                    badge.textContent = ''; // Очищаем текст
                }
            }
        }


        function startMatchSearch(format) {
            if (!currentUser) {
                alert('Войдите, чтобы искать матч');
                return;
            }
            for (const fmt in playersInSearch) {
                if (playersInSearch[fmt].includes(currentUser)) {
                    alert('Вы уже находитесь в поиске матча. Отмените текущий поиск, чтобы начать новый.');
                    return;
                }
            }

            currentMatchFormat = format;
            neededPlayersCount = format * 2;
            foundPlayers = [];
            selectedMap = '';
            captainLogins = [];
            teams = { teamA: [], teamB: [] };
            currentCaptainTurn = 0;
            playersToPick = [];

            if (!playersInSearch[currentMatchFormat]) {
                playersInSearch[currentMatchFormat] = [];
            }
            if (!playersInSearch[currentMatchFormat].includes(currentUser)) {
                playersInSearch[currentMatchFormat].push(currentUser);
            }

            showSection('matchPage');
            matchFormatButtons.classList.add('hidden');
            waitingPlayersDiv.classList.remove('hidden');
            cancelMatchSearchBtn.classList.remove('hidden');
            matchSetupDiv.classList.add('hidden');
            matchFoundNotification.classList.add('hidden');
            document.getElementById('captainDraftArea').classList.add('hidden');
            endDraftBtn.classList.add('hidden');

            updateWaitingPlayers();
            saveMatchState();

            if (searchIntervalId) {
                clearInterval(searchIntervalId);
            }
            searchIntervalId = setInterval(simulatePlayerSearch, 1500);
        }

        function cancelMatchSearch() {
            clearInterval(searchIntervalId);
            searchIntervalId = null;

            if (currentUser && playersInSearch[currentMatchFormat]) {
                playersInSearch[currentMatchFormat] = playersInSearch[currentMatchFormat].filter(p => p !== currentUser);
                if (playersInSearch[currentMatchFormat].length === 0) {
                    delete playersInSearch[currentMatchFormat];
                }
            }

            foundPlayers = [];
            neededPlayersCount = 0;
            currentMatchFormat = 0;
            selectedMap = '';
            captainLogins = [];
            teams = { teamA: [], teamB: [] };
            currentCaptainTurn = 0;
            playersToPick = [];

            waitingPlayersDiv.classList.add('hidden');
            matchSetupDiv.classList.add('hidden');
            cancelMatchSearchBtn.classList.add('hidden');
            matchFoundNotification.classList.add('hidden');
            endDraftBtn.classList.add('hidden');

            matchFormatButtons.classList.remove('hidden');
            if (waitingPlayersList) {
                waitingPlayersList.innerHTML = '';
            }
            document.getElementById('captainDraftArea').classList.add('hidden');
            localStorage.removeItem('matchState');
        }

        function updateWaitingPlayers() {
            if (!waitingPlayersList) return;
            waitingPlayersList.innerHTML = '';

            const playersToDisplay = playersInSearch[currentMatchFormat] || [];
            playersToDisplay.forEach(login => {
                const user = users[login];
                const li = document.createElement('li');
                li.textContent = `${login} (Game ID: ${user.gameId})`;
                waitingPlayersList.appendChild(li);
            });
            saveMatchState();
        }

        function simulatePlayerSearch() {
            if (!currentUser || !playersInSearch[currentMatchFormat] || !playersInSearch[currentMatchFormat].includes(currentUser)) {
                clearInterval(searchIntervalId);
                searchIntervalId = null;
                return;
            }

            foundPlayers = [...playersInSearch[currentMatchFormat]];

            if (foundPlayers.length >= neededPlayersCount) {
                clearInterval(searchIntervalId);
                searchIntervalId = null;
                matchFoundNotification.classList.remove('hidden');
                saveMatchState();

                foundPlayers.forEach(player => {
                    if (playersInSearch[currentMatchFormat]) {
                        playersInSearch[currentMatchFormat] = playersInSearch[currentMatchFormat].filter(p => p !== player);
                    }
                });
                if (playersInSearch[currentMatchFormat] && playersInSearch[currentMatchFormat].length === 0) {
                    delete playersInSearch[currentMatchFormat];
                }

                setTimeout(() => {
                    matchFoundNotification.classList.add('hidden');
                    startMatchSetup();
                }, 2000);
                return;
            }

            const potentialPlayers = Object.keys(users).filter(login =>
                login !== currentUser &&
                !users[login].isBanned &&
                (!playersInSearch[currentMatchFormat] || !playersInSearch[currentMatchFormat].includes(login))
            );

            if (potentialPlayers.length > 0) {
                const randomIndex = Math.floor(Math.random() * potentialPlayers.length);
                const randomPlayer = potentialPlayers[randomIndex];

                if (!playersInSearch[currentMatchFormat].includes(randomPlayer)) {
                    playersInSearch[currentMatchFormat].push(randomPlayer);
                }
                foundPlayers = [...playersInSearch[currentMatchFormat]];
                updateWaitingPlayers();
            }
        }

        function startMatchSetup(isFromLoad = false) {
            matchFormatButtons.classList.add('hidden');
            waitingPlayersDiv.classList.add('hidden');

            matchSetupDiv.classList.remove('hidden');

            if (!isFromLoad) {
                const randomIndex = Math.floor(Math.random() * maps.length);
                selectedMap = maps[randomIndex];

                captainLogins = [];
                const potentialCaptains = [...foundPlayers];

                if (potentialCaptains.length >= 2) {
                    const captain1Index = Math.floor(Math.random() * potentialCaptains.length);
                    captainLogins.push(potentialCaptains.splice(captain1Index, 1)[0]);

                    const captain2Index = Math.floor(Math.random() * potentialCaptains.length);
                    captainLogins.push(potentialCaptains.splice(captain2Index, 1)[0]);
                } else {
                    alert('Недостаточно игроков для начала драфта. Найдено: ' + foundPlayers.length);
                    cancelMatchSearch();
                    return;
                }

                teams.teamA = [captainLogins[0]];
                teams.teamB = [captainLogins[1]];

                playersToPick = foundPlayers.filter(player => !captainLogins.includes(player));

                currentCaptainTurn = Math.random() < 0.5 ? 0 : 1;
            }

            document.getElementById('selectedMap').textContent = selectedMap;

            if (captainLogins.length === 2) {
                document.getElementById('captainDraftArea').classList.remove('hidden');
                setupCaptainDraft(isFromLoad);
                if (currentUser && (captainLogins[0] === currentUser || captainLogins[1] === currentUser || currentUser === 'HAESHE4KA')) {
                    endDraftBtn.classList.remove('hidden');
                } else {
                    endDraftBtn.classList.add('hidden');
                }
            } else {
                alert('Не удалось определить капитанов для драфта. Недостаточно игроков.');
                cancelMatchSearch();
            }
            saveMatchState();
        }

        function setupCaptainDraft(isFromLoad = false) {
            const captainsInfoDiv = document.getElementById('captainsInfo');
            const playerListDiv = document.getElementById('playerList');

            captainsInfoDiv.innerHTML = `<b>Капитан 1:</b> ${captainLogins[0]}, <b>Капитан 2:</b> ${captainLogins[1]}`;

            playerListDiv.innerHTML = '';
            playersToPick.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.classList.add('player-selectable');
                playerDiv.textContent = player;
                playerDiv.onclick = () => selectPlayer(player);
                playerListDiv.appendChild(playerDiv);
            });

            updateCaptainTurnDisplay();
            updateTeamViews();
            saveMatchState();
        }

        function updateCaptainTurnDisplay() {
            const sideA = document.getElementById('sideA');
            const sideB = document.getElementById('sideB');

            sideA.style.fontWeight = 'normal';
            sideB.style.fontWeight = 'normal';
            sideA.style.color = 'white';
            sideB.style.color = 'white';

            if (playersToPick.length === 0) {
                sideA.textContent = '';
                sideB.textContent = '';
                endDraftBtn.classList.add('hidden');
                return;
            }

            if (currentCaptainTurn === 0) {
                sideA.textContent = 'Выбирает';
                sideB.textContent = '';
                sideA.style.fontWeight = 'bold';
                sideA.style.color = '#4caf50';
            } else {
                sideB.textContent = 'Выбирает';
                sideA.textContent = '';
                sideB.style.fontWeight = 'bold';
                sideB.style.color = '#4caf50';
            }
            saveMatchState();
        }

        function selectPlayer(playerName) {
            if (!currentUser) return;
            const pickingCaptainLogin = captainLogins[currentCaptainTurn];
            if (currentUser !== pickingCaptainLogin && currentUser !== 'HAESHE4KA') {
                alert('Сейчас не ваш ход. Ход капитана ' + pickingCaptainLogin);
                return;
            }

            const playerListDiv = document.getElementById('playerList');
            const selectedPlayerDiv = Array.from(playerListDiv.children).find(div => div.textContent === playerName);

            if (selectedPlayerDiv && playersToPick.includes(playerName)) {
                playersToPick = playersToPick.filter(p => p !== playerName);

                selectedPlayerDiv.classList.remove('player-selectable');
                selectedPlayerDiv.classList.add('player-selected');
                selectedPlayerDiv.onclick = null;

                if (currentCaptainTurn === 0) {
                    teams.teamA.push(playerName);
                } else {
                    teams.teamB.push(playerName);
                }

                updateTeamViews();
                switchCaptain();
                saveMatchState();

                if (playersToPick.length === 0) {
                    alert('Драфт завершен!');
                    endDraftCleanup();
                }
            } else {
                alert('Этот игрок уже выбран или не доступен для выбора.');
            }
        }

        function updateTeamViews() {
            const teamAPlayersList = document.getElementById('teamAPlayers');
            const teamBPlayersList = document.getElementById('teamBPlayers');

            teamAPlayersList.innerHTML = '';
            teams.teamA.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player;
                teamAPlayersList.appendChild(li);
            });

            teamBPlayersList.innerHTML = '';
            teams.teamB.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player;
                teamBPlayersList.appendChild(li);
            });
            saveMatchState();
        }

        function switchCaptain() {
            currentCaptainTurn = 1 - currentCaptainTurn;
            updateCaptainTurnDisplay();
            saveMatchState();
        }

        function endDraftEarly() {
            if (!currentUser || !(captainLogins[0] === currentUser || captainLogins[1] === currentUser || currentUser === 'HAESHE4KA')) {
                alert('Только капитан или администратор (HAESHE4KA) может завершить драфт досрочно.');
                return;
            }

            if (confirm('Вы уверены, что хотите досрочно завершить драфт? Оставшиеся игроки не будут распределены.')) {
                alert('Драфт завершен ' + currentUser + ' досрочно!');
                endDraftCleanup();
            }
        }

        function endDraftCleanup() {
            localStorage.removeItem('matchState');
            matchFormatButtons.classList.remove('hidden');
            matchSetupDiv.classList.add('hidden');
            document.getElementById('captainDraftArea').classList.add('hidden');
            endDraftBtn.classList.add('hidden');
            foundPlayers = [];
            neededPlayersCount = 0;
            currentMatchFormat = 0;
            selectedMap = '';
            captainLogins = [];
            teams = { teamA: [], teamB: [] };
            currentCaptainTurn = 0;
            playersToPick = [];
            showSection('matchPage');
        }

        function submitConfirmation() {
            if (!currentUser) {
                alert('Войдите, чтобы отправить подтверждение.');
                return;
            }

            const matchImageInput = document.getElementById('matchImage');
            const matchStatsTextarea = document.getElementById('matchStats');
            const confirmationMessageDiv = document.getElementById('confirmationMessage');

            const imageFile = matchImageInput.files[0];
            const statsText = matchStatsTextarea.value.trim();

            if (!imageFile && !statsText) {
                confirmationMessageDiv.textContent = 'Пожалуйста, прикрепите изображение или введите статистику.';
                confirmationMessageDiv.style.color = 'red';
                return;
            }

            console.log('Attempting to send confirmation. File:', imageFile, 'Text:', statsText);

            let imageDataUrl = '';
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageDataUrl = e.target.result;
                    sendConfirmationRequest(imageDataUrl, statsText);
                    matchImageInput.value = ''; // Очищаем поле
                    matchStatsTextarea.value = ''; // Очищаем поле
                };
                reader.onerror = function(e) {
                    console.error("Error reading image file:", e);
                    confirmationMessageDiv.textContent = 'Ошибка при чтении файла изображения.';
                    confirmationMessageDiv.style.color = 'red';
                };
                reader.readAsDataURL(imageFile);
            } else {
                sendConfirmationRequest(imageDataUrl, statsText);
                matchImageInput.value = ''; // Очищаем поле
                matchStatsTextarea.value = ''; // Очищаем поле
            }
        }

        function sendConfirmationRequest(imageDataUrl, statsText) {
            const confirmationMessageDiv = document.getElementById('confirmationMessage');

            const request = {
                id: Date.now() + Math.random(),
                sender: currentUser,
                timestamp: new Date().toLocaleString('ru-RU'),
                imageData: imageDataUrl,
                statsText: statsText
            };

            verificationRequests.push(request);
            localStorage.setItem('verificationRequests', JSON.stringify(verificationRequests));
            console.log('Confirmation request saved:', verificationRequests);

            confirmationMessageDiv.textContent = 'Подтверждение отправлено на проверку!';
            confirmationMessageDiv.style.color = 'lightgreen';

            if (document.getElementById('verificationPage').classList.contains('hidden') === false) {
                loadVerificationRequests();
            }
        }

        function loadVerificationRequests() {
            const container = document.getElementById('verificationRequestsContainer');
            const noRequestsMessage = document.getElementById('noRequestsMessage');

            // Очищаем контейнер полностью от всех дочерних элементов
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            try {
                verificationRequests = JSON.parse(localStorage.getItem('verificationRequests') || '[]');
            } catch (e) {
                console.error("Error parsing verificationRequests from localStorage:", e);
                verificationRequests = [];
            }

            console.log('Loading verification requests. Current requests:', verificationRequests);

            if (verificationRequests.length === 0) {
                noRequestsMessage.classList.remove('hidden');
                container.appendChild(noRequestsMessage);
            } else {
                noRequestsMessage.classList.add('hidden');

                verificationRequests.forEach(request => {
                    const requestDiv = document.createElement('div');
                    requestDiv.className = 'request-item';
                    requestDiv.dataset.requestId = request.id;

                    requestDiv.innerHTML = `
                        <button class="close-button" onclick="deleteVerificationRequest(${request.id})">&times;</button>
                        <h4>Отправитель: ${request.sender}</h4>
                        <p>Время отправки: ${request.timestamp}</p>
                        ${request.imageData ? `<img src="${request.imageData}" alt="Скриншот матча">` : ''}
                        ${request.statsText ? `<b>Статистика матча:</b><pre>${request.statsText}</pre>` : ''}
                        <div class="action-buttons">
                            <button onclick="processVerificationRequest(${request.id}, true)">Применить ELO</button>
                            <button class="delete-button" onclick="deleteVerificationRequest(${request.id})">Отклонить</button>
                        </div>
                    `;
                    container.appendChild(requestDiv);
                });
            }
        }

        function processVerificationRequest(requestId, applyElo) {
            console.log(`Processing request ID: ${requestId}. Apply ELO: ${applyElo}`);
            console.log('Requests before processing:', JSON.parse(JSON.stringify(verificationRequests)));

            const requestIndex = verificationRequests.findIndex(req => req.id === requestId);

            if (requestIndex === -1) {
                console.warn('Request with ID ' + requestId + ' not found in array. It might have been already processed or an ID mismatch occurred.');
                alert('Запрос уже обработан или не найден.'); // Добавлено для пользователя
                return;
            }

            const request = verificationRequests[requestIndex];
            let actionMessage = '';

            if (applyElo) {
                if (request.statsText) {
                    const result = updateEloFromForumPost(request.statsText);
                    actionMessage = `ELO updated for request from ${request.sender}.\nResult:\n${result}`;
                } else {
                    actionMessage = `Cannot apply ELO: no stats text in request from ${request.sender}.`;
                }
                alert(actionMessage);
            } else {
                actionMessage = `Request from ${request.sender} rejected.`;
                alert(actionMessage);
            }

            verificationRequests.splice(requestIndex, 1);
            localStorage.setItem('verificationRequests', JSON.stringify(verificationRequests));
            console.log('Request processed and removed. Current requests after processing:', verificationRequests);

            loadVerificationRequests();
        }

        function deleteVerificationRequest(requestId) {
            console.log(`Attempting to delete request ID: ${requestId}`);
            console.log('Requests before deletion:', JSON.parse(JSON.stringify(verificationRequests)));

            if (confirm('Are you sure you want to delete this request?')) {
                verificationRequests = verificationRequests.filter(req => req.id !== requestId);
                localStorage.setItem('verificationRequests', JSON.stringify(verificationRequests));
                console.log('Request deleted. Current requests after deletion:', verificationRequests);
                loadVerificationRequests();
            } else {
                console.log('Deletion cancelled for request ID:', requestId);
            }
        }

        // --- Функции админ-панели (без изменений) ---
        function banUser() {
            const userToBan = document.getElementById('banUserInput').value.trim();
            const banUserResult = document.getElementById('banUserResult');

            if (!userToBan) {
                banUserResult.textContent = 'Введите логин пользователя.';
                banUserResult.style.color = 'red';
                return;
            }
            if (!users[userToBan]) {
                banUserResult.textContent = 'Пользователь не найден.';
                banUserResult.style.color = 'red';
                return;
            }
            if (users[userToBan].isBanned) {
                banUserResult.textContent = 'Пользователь уже забанен.';
                banUserResult.style.color = 'orange';
                return;
            }
            users[userToBan].isBanned = true;
            localStorage.setItem('users', JSON.stringify(users));
            banUserResult.textContent = `Пользователь ${userToBan} забанен.`;
            banUserResult.style.color = 'lightgreen';
        }

        function unbanUser() {
            const userToUnban = document.getElementById('unbanUserInput').value.trim();
            const unbanUserResult = document.getElementById('unbanUserResult');

            if (!userToUnban) {
                unbanUserResult.textContent = 'Введите логин пользователя.';
                unbanUserResult.style.color = 'red';
                return;
            }
            if (!users[userToUnban]) {
                unbanUserResult.textContent = 'Пользователь не найден.';
                unbanUserResult.style.color = 'red';
                return;
            }
            if (!users[userToUnban].isBanned) {
                unbanUserResult.textContent = 'Пользователь не забанен.';
                unbanUserResult.style.color = 'orange';
                return;
            }
            delete users[userToUnban].isBanned;
            localStorage.setItem('users', JSON.stringify(users));
            unbanUserResult.textContent = `Пользователь ${userToUnban} разбанен.`;
            unbanUserResult.style.color = 'lightgreen';
        }

        function deleteUser() {
            const userToDelete = document.getElementById('deleteUserInput').value.trim();
            const deleteUserResult = document.getElementById('deleteUserResult');

            if (!userToDelete) {
                deleteUserResult.textContent = 'Введите логин пользователя.';
                deleteUserResult.style.color = 'red';
                return;
            }
            if (!users[userToDelete]) {
                deleteUserResult.textContent = 'Пользователь не найден.';
                deleteUserResult.style.color = 'red';
                return;
            }
            if (confirm(`Вы уверены, что хотите удалить пользователя ${userToDelete}? Это действие необратимо.`)) {
                delete users[userToDelete];
                localStorage.setItem('users', JSON.stringify(users));
                deleteUserResult.textContent = `Пользователь ${userToDelete} удален.`;
                deleteUserResult.style.color = 'lightgreen';
                if (currentUser === userToDelete) {
                    logout();
                }
            } else {
                deleteUserResult.textContent = 'Удаление отменено.';
                deleteUserResult.style.color = 'white';
            }
        }

        function changeNickname() {
            const userLogin = document.getElementById('changeNickUserInput').value.trim();
            const newNick = document.getElementById('newNickInput').value.trim();
            const changeNickResult = document.getElementById('changeNickResult');

            if (!userLogin || !newNick) {
                changeNickResult.textContent = 'Введите логин пользователя и новый никнейм.';
                changeNickResult.style.color = 'red';
                return;
            }
            if (!users[userLogin]) {
                changeNickResult.textContent = 'Пользователь не найден.';
                changeNickResult.style.color = 'red';
                return;
            }
            if (users[newNick]) {
                changeNickResult.textContent = 'Никнейм уже занят.';
                changeNickResult.style.color = 'red';
                return;
            }

            const userData = users[userLogin];
            delete users[userLogin];
            users[newNick] = userData;

            if (currentUser === userLogin) {
                currentUser = newNick;
                localStorage.setItem('loggedInUser', currentUser); // Обновляем логин и в localStorage
            }

            localStorage.setItem('users', JSON.stringify(users));
            changeNickResult.textContent = `Никнейм пользователя ${userLogin} изменен на ${newNick}.`;
            changeNickResult.style.color = 'lightgreen';
            updateNavbar();
        }

        function changeGameId() {
            const userLogin = document.getElementById('changeGameIdUserInput').value.trim();
            const newGameId = document.getElementById('newGameIdInput').value.trim();
            const changeGameIdResult = document.getElementById('changeGameIdResult');

            if (!userLogin || !newGameId) {
                changeGameIdResult.textContent = 'Введите логин пользователя и новый Game ID.';
                changeGameIdResult.style.color = 'red';
                return;
            }
            if (!users[userLogin]) {
                changeGameIdResult.textContent = 'Пользователь не найден.';
                changeGameIdResult.style.color = 'red';
                return;
            }
            for (const u in users) {
                if (users[u].gameId === newGameId && u !== userLogin) {
                    changeGameIdResult.textContent = 'Game ID уже используется другим игроком.';
                    changeGameIdResult.style.color = 'red';
                    return;
                }
            }

            users[userLogin].gameId = newGameId;
            localStorage.setItem('users', JSON.stringify(users));
            changeGameIdResult.textContent = `Game ID пользователя ${userLogin} изменен на ${newGameId}.`;
            changeGameIdResult.style.color = 'lightgreen';
            loadProfile();
        }

        function changeRating() {
            const userLogin = document.getElementById('changeRatingUserInput').value.trim();
            const newRating = parseInt(document.getElementById('newRatingInput').value);
            const changeRatingResult = document.getElementById('changeRatingResult');

            if (!userLogin || isNaN(newRating)) {
                changeRatingResult.textContent = 'Введите логин пользователя и новый рейтинг (число).';
                changeRatingResult.style.color = 'red';
                return;
            }
            if (!users[userLogin]) {
                changeRatingResult.textContent = 'Пользователь не найден.';
                changeRatingResult.style.color = 'red';
                return;
            }

            users[userLogin].rating = newRating;
            localStorage.setItem('users', JSON.stringify(users));
            changeRatingResult.textContent = `Рейтинг пользователя ${userLogin} изменен на ${newRating}.`;
            changeRatingResult.style.color = 'lightgreen';
            loadProfile();
        }


        // --- Инициализация при загрузке страницы ---
        // Сначала пытаемся войти автоматически
        autoLogin();
        // Затем обновляем навигационную панель в зависимости от того, вошел ли пользователь
        // updateNavbar() уже вызывается в autoLogin(), поэтому здесь не дублируем
        // updateChatNotificationBadge() также вызывается в updateNavbar()
        // Это предотвращает дублирование вызовов и гарантирует правильный порядок.


        window.addEventListener('beforeunload', function (e) {
            if (searchIntervalId !== null || (foundPlayers.length === neededPlayersCount && neededPlayersCount > 0 && playersToPick.length > 0)) {
                cancelMatchSearch();
            }
        });
    </script>
</body>
</html>